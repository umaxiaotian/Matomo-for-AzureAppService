name: Build & Test & Push Matomo Image (GHCR)

permissions:
  contents: read
  packages: write

on:
  workflow_dispatch:
    inputs:
      matomo_version:
        description: "Matomo version (e.g. 5.6.1)"
        required: true
        default: "5.6.1"
      php_memory_limit:
        description: "PHP memory_limit (e.g. 256M)"
        required: true
        default: "256M"

env:
  IMAGE_NAME: matomo-appservice-rebuild

jobs:
  # =========================
  # 1) ãƒ“ãƒ«ãƒ‰ & ãƒ†ã‚¹ãƒˆ
  # =========================
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # .env ã‚’ç”Ÿæˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ« docker-compose ã¨åŒã˜å½¢å¼ï¼‰
      - name: Generate .env file
        run: |
          cat <<EOF > .env
          MATOMO_VERSION=${{ inputs.matomo_version }}
          PHP_MEMORY_LIMIT=${{ inputs.php_memory_limit }}
          EOF
          echo ".env generated:"
          cat .env

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ãƒ†ã‚¹ãƒˆç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ï¼ˆpush ã—ãªã„ / runner ã« loadï¼‰
      - name: Build image for test (no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          build-args: |
            MATOMO_VERSION=${{ inputs.matomo_version }}
            PHP_MEMORY_LIMIT=${{ inputs.php_memory_limit }}
          tags: |
            matomo-test:${{ github.sha }}

      # ç°¡æ˜“ PHP æ‹¡å¼µãƒã‚§ãƒƒã‚¯
      - name: Simple PHP extension check
        run: |
          set -e

          echo "== php -m =="
          docker run --rm matomo-test:${{ github.sha }} php -m

          echo "== check required extensions =="
          for ext in gd mysqli pdo_mysql bcmath zip redis apcu; do
            echo "Checking extension: $ext"
            if ! docker run --rm matomo-test:${{ github.sha }} php -m | grep -q "$ext"; then
              echo "ERROR: PHP extension '$ext' not found."
              exit 1
            fi
          done

      # è¶…ç°¡æ˜“ HTTP ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ
      - name: HTTP smoke test (apache + matomo)
        run: |
          set -e

          docker run -d --name matomo-http-test \
            -p 8080:80 \
            matomo-test:${{ github.sha }}

          echo "Waiting for container to be ready..."
          # Matomo ã®èµ·å‹•ãŒé‡ã‘ã‚Œã°å¢—ã‚„ã™
          sleep 40

          echo "Requesting http://localhost:8080/ ..."
          http_status=$(curl -sS -o /tmp/index.html -w "%{http_code}" http://localhost:8080/ || echo "000")
          echo "HTTP status: $http_status"

          if [ "$http_status" != "200" ]; then
            echo "ERROR: Expected HTTP 200 but got $http_status"
            echo "===== /tmp/index.html (if any) ====="
            cat /tmp/index.html || true
            echo "===== Container logs ====="
            docker logs matomo-http-test || true
            docker rm -f matomo-http-test || true
            exit 1
          fi

          # HTML ã®ä¸­ã« Matomo ã£ã½ã„æ–‡è¨€ãŒã‚ã‚‹ã‹ã‚¶ãƒƒã‚¯ãƒªç¢ºèª
          if ! grep -qi "Matomo" /tmp/index.html; then
            echo "WARNING: 'Matomo' keyword not found in index.html"
            # ã“ã“ã§å¤±æ•—ã•ã›ãŸã‘ã‚Œã° exit 1 ã«å¤‰ãˆã¦OK
          fi

          echo "===== /tmp/index.html (head) ====="
          head -n 50 /tmp/index.html || true

          echo "===== Container logs ====="
          docker logs matomo-http-test || true

          docker rm -f matomo-http-test || true

      # ğŸ” Trivy ã«ã‚ˆã‚‹è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆHIGH/CRITICAL ãŒã‚ã‚Œã°å¤±æ•—ã•ã›ã‚‹ï¼‰
      - name: Scan image for vulnerabilities (Trivy)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: matomo-test:${{ github.sha }}
          vuln-type: 'os,library'
          severity: 'HIGH,CRITICAL'
          ignore-unfixed: true
          format: 'table'
          exit-code: '1'   # â† HIGH/CRITICAL ãŒ1ä»¶ã§ã‚‚ã‚ã‚Œã°ã‚¸ãƒ§ãƒ–å¤±æ•—

  # =========================
  # 2) GHCR ã¸ push
  # =========================
  push:
    runs-on: ubuntu-latest
    needs: build-and-test   # â† ãƒ†ã‚¹ãƒˆ + è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯é€šã£ãŸã‚‰ã ã‘å®Ÿè¡Œ

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # .env ã‚’ç”Ÿæˆï¼ˆä¸Šã¨åŒã˜ï¼‰
      - name: Generate .env file
        run: |
          cat <<EOF > .env
          MATOMO_VERSION=${{ inputs.matomo_version }}
          PHP_MEMORY_LIMIT=${{ inputs.php_memory_limit }}
          EOF
          echo ".env generated:"
          cat .env

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # GitHub Container Registry ã«ãƒ­ã‚°ã‚¤ãƒ³
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.PUSH_GITHUB_TOKEN }}

      # ãƒ“ãƒ«ãƒ‰ã—ã¦ GHCR ã« push
      - name: Build and push to GHCR
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          build-args: |
            MATOMO_VERSION=${{ inputs.matomo_version }}
            PHP_MEMORY_LIMIT=${{ inputs.php_memory_limit }}
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ inputs.matomo_version }}
            ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest
