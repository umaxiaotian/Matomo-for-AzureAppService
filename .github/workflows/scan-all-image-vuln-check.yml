name: Scan ALL Matomo Image Tags

permissions:
  contents: read
  packages: read
  issues: write

on:
  schedule:
    # 毎日 0:00 UTC
    - cron: "0 0 * * *"
  workflow_dispatch: {}

env:
  IMAGE_NAME: matomo-appservice-rebuild

jobs:
  # =========================
  # 1) GHCR から全タグ一覧を取得
  # =========================
  fetch-tags:
    runs-on: ubuntu-latest

    outputs:
      tags: ${{ steps.collect.outputs.tags }}

    steps:
      - name: Checkout (optional)
        uses: actions/checkout@v4

      - name: Collect tags from GHCR
        id: collect
        env:
          GHCR_OWNER: ${{ github.repository_owner }}
          GHCR_TOKEN: ${{ secrets.PUSH_GITHUB_TOKEN }}
          GHCR_PACKAGE: ${{ env.IMAGE_NAME }}
        run: |
          set -e

          API_URL="https://api.github.com/users/${GHCR_OWNER}/packages/container/${GHCR_PACKAGE}/versions?per_page=100"
          echo "Fetching GHCR versions from: $API_URL"

          curl -sSL \
            -H "Authorization: Bearer ${GHCR_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "$API_URL" > resp.json

          echo "Raw response:"
          cat resp.json

          # tags を全部集めてユニーク化し、"latest" を除外する
          tags_json=$(jq -r '
            .[]
            | .metadata.container.tags[]?
            | select(. != "latest")     # ← ★ ここで latest を除外
          ' resp.json 2>/dev/null | sort -u | jq -R . | jq -s -c .)

          if [ -z "$tags_json" ] || [ "$tags_json" = "[]" ]; then
            echo "No non-latest tags found."
            echo 'tags=[]' >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Found tags (excluding latest): $tags_json"
          echo "tags=$tags_json" >> "$GITHUB_OUTPUT"


  # =========================
  # 2) タグごとに Trivy スキャン
  # =========================
  scan:
    runs-on: ubuntu-latest
    needs: fetch-tags

    strategy:
      fail-fast: false
      matrix:
        tag: ${{ fromJson(needs.fetch-tags.outputs.tags) }}

    steps:
      - name: Checkout (optional)
        uses: actions/checkout@v4

      - name: Show target image
        run: |
          echo "Scanning ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ matrix.tag }}"

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.PUSH_GITHUB_TOKEN }}

      # Trivy スキャン（HIGH/CRITICALのみ）
      - name: Scan image with Trivy
        id: trivy
        env:
          GHCR_OWNER: ${{ github.repository_owner }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          IMAGE_TAG: ${{ matrix.tag }}
        uses: aquasecurity/trivy-action@v0.2.4
        with:
          image-ref: ghcr.io/${{ env.GHCR_OWNER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          format: json
          output: trivy.json
          vuln-type: 'os,library'
          severity: 'HIGH,CRITICAL'
          ignore-unfixed: true

      # JSON -> 件数 & Markdown レポート生成
      - name: Summarize vulnerabilities
        id: summary
        env:
          GHCR_OWNER: ${{ github.repository_owner }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          IMAGE_TAG: ${{ matrix.tag }}
        run: |
          set -e

          total=$(jq '[.Results[].Vulnerabilities? // [] | length] | add // 0' trivy.json)
          echo "total=$total" >> "$GITHUB_OUTPUT"

          if [ "$total" -eq 0 ]; then
            exit 0
          fi

          jq -r '
            .Results[]
            | select(.Vulnerabilities != null)
            | .Target as $target
            | .Vulnerabilities[]
            | select(.Severity == "HIGH" or .Severity == "CRITICAL")
            | "| \($target) | \(.VulnerabilityID) | \(.PkgName) | \(.InstalledVersion) | \(.FixedVersion // "-") | \(.Severity) |"
          ' trivy.json > table_rows.txt || true

          cat > trivy-report.md <<'EOF'
          # Container vulnerability report
          
          Image: `ghcr.io/${GHCR_OWNER}/${IMAGE_NAME}:${IMAGE_TAG}`
          
          | Target | CVE | Package | Installed | Fixed | Severity |
          |--------|-----|---------|-----------|-------|----------|
          EOF

          cat table_rows.txt >> trivy-report.md

          echo "" >> trivy-report.md
          echo "> This issue was generated automatically by a scheduled GitHub Actions workflow." >> trivy-report.md


      # タグごとに Issue 作成 or 追記
      - name: Create or update issue for this tag
        if: steps.summary.outputs.total != '0'
        uses: actions/github-script@v7
        env:
          IMAGE_TAG: ${{ matrix.tag }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const tag = process.env.IMAGE_TAG;
            const title = `[Security] Vulnerabilities found in GHCR image tag ${tag}`;
            const body = fs.readFileSync('trivy-report.md', 'utf8');

            // 同じタグ用のオープンIssueがあるか
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'container-security',
            });

            const existing = issues.find(i => i.title === title);

            if (existing) {
              core.info(`Existing issue #${existing.number} for tag ${tag}. Adding a comment.`);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                body,
              });
            } else {
              core.info(`Creating new issue for tag ${tag}.`);
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['container-security', 'security', 'automated'],
              });
            }
