name: Scan ALL Matomo Image Tags

permissions:
  contents: read
  packages: read
  issues: write

on:
  schedule:
    # 毎日 0:00 UTC
    - cron: "0 0 * * *"
  workflow_dispatch: {}

env:
  IMAGE_NAME: matomo-appservice-rebuild

jobs:
  # =========================
  # 1) GHCR から全タグ一覧を取得
  # =========================
  fetch-tags:
    runs-on: ubuntu-latest

    outputs:
      tags: ${{ steps.collect.outputs.tags }}

    steps:
      - name: Checkout (optional)
        uses: actions/checkout@v4

      - name: Collect tags from GHCR
        id: collect
        env:
          GHCR_OWNER: ${{ github.repository_owner }}
          GHCR_TOKEN: ${{ secrets.PUSH_GITHUB_TOKEN }}
          GHCR_PACKAGE: ${{ env.IMAGE_NAME }}
        run: |
          set -e

          API_URL="https://api.github.com/users/${GHCR_OWNER}/packages/container/${GHCR_PACKAGE}/versions?per_page=100"
          echo "Fetching GHCR versions from: $API_URL"

          curl -sSL \
            -H "Authorization: Bearer ${GHCR_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "$API_URL" > resp.json

          echo "Raw response:"
          cat resp.json

          # tags を全部集めてユニーク化し、"latest" を除外する
          tags_json=$(jq -r '
            .[]
            | .metadata.container.tags[]?
            | select(. != "latest")
          ' resp.json 2>/dev/null | sort -u | jq -R . | jq -s -c .)

          if [ -z "$tags_json" ] || [ "$tags_json" = "[]" ]; then
            echo "No non-latest tags found."
            echo 'tags=[]' >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Found tags (excluding latest): $tags_json"
          echo "tags=$tags_json" >> "$GITHUB_OUTPUT"


  # =========================
  # 2) タグごとに Trivy スキャン（Vuln + Secrets + Misconfig）
  # =========================
  scan:
    runs-on: ubuntu-latest
    needs: fetch-tags

    strategy:
      fail-fast: false
      matrix:
        tag: ${{ fromJson(needs.fetch-tags.outputs.tags) }}

    steps:
      - name: Checkout (optional)
        uses: actions/checkout@v4

      - name: Show target image
        run: |
          echo "Scanning ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ matrix.tag }}"

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.PUSH_GITHUB_TOKEN }}

      # Trivy スキャン（HIGH/CRITICAL vuln + Secrets + Misconfig）
      - name: Scan image with Trivy
        id: trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ matrix.tag }}
          format: json
          output: trivy.json
          vuln-type: 'os,library'
          severity: 'HIGH,CRITICAL'   # ← 脆弱性は HIGH/CRITICAL に絞る
          ignore-unfixed: true        # ← 修正パッチのあるものだけ
          scanners: 'vuln,misconfig,secret'  # ← Config(Misconfig) + Secrets もスキャン
          exit-code: '0'              # ← ここでは失敗させない（後段で件数見て判断）

      # JSON -> vuln件数 + secret件数 + misconfig件数 を集計 & Markdown レポート生成
      - name: Summarize vulnerabilities, secrets and misconfigurations
        id: summary
        env:
          GHCR_OWNER: ${{ github.repository_owner }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          IMAGE_TAG: ${{ matrix.tag }}
        run: |
          set -e

          if [ ! -f trivy.json ]; then
            echo "trivy.json not found; something went wrong in Trivy step."
            echo "total=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # HIGH/CRITICAL の OS/library 脆弱性件数
          total_vuln=$(jq '[.Results[].Vulnerabilities? // [] | length] | add // 0' trivy.json)
          # Secrets の件数
          total_secret=$(jq '[.Results[].Secrets? // [] | length] | add // 0' trivy.json)
          # Misconfig(Config) の件数
          total_misconf=$(jq '[.Results[].Misconfigurations? // [] | length] | add // 0' trivy.json)

          total=$((total_vuln + total_secret + total_misconf))

          echo "Total HIGH/CRITICAL vulnerabilities: ${total_vuln}"
          echo "Total secrets: ${total_secret}"
          echo "Total misconfigurations: ${total_misconf}"
          echo "Total issues (vuln + secrets + misconfig) for ${IMAGE_TAG}: ${total}"

          echo "total_vuln=$total_vuln" >> "$GITHUB_OUTPUT"
          echo "total_secret=$total_secret" >> "$GITHUB_OUTPUT"
          echo "total_misconf=$total_misconf" >> "$GITHUB_OUTPUT"
          echo "total=$total" >> "$GITHUB_OUTPUT"

          if [ "$total" -eq 0 ]; then
            echo "No HIGH/CRITICAL vulnerabilities, secrets or misconfigurations. Skipping issue creation."
            exit 0
          fi

          # ===== Vulnerabilities テーブル作成 =====
          jq -r '
            .Results[]
            | select(.Vulnerabilities != null)
            | .Target as $target
            | .Vulnerabilities[]
            | select(.Severity == "HIGH" or .Severity == "CRITICAL")
            | "| \($target) | \(.VulnerabilityID) | \(.PkgName) | \(.InstalledVersion) | \(.FixedVersion // "-") | \(.Severity) |"
          ' trivy.json > vuln_rows.txt || true

          # ===== Secrets テーブル作成 =====
          jq -r '
            .Results[]
            | select(.Secrets != null)
            | .Target as $target
            | .Secrets[]
            | "| \($target) | \(.RuleID // "-") | \(.Category // "-") | \(.Location // "-") | \(.Severity // "-") |"
          ' trivy.json > secret_rows.txt || true

          # ===== Misconfig(Misconfiguration) テーブル作成 =====
          jq -r '
            .Results[]
            | select(.Misconfigurations != null)
            | .Target as $target
            | .Misconfigurations[]
            | "| \($target) | \(.ID // "-") | \(.Title // "-") | \(.Severity // "-") |"
          ' trivy.json > misconf_rows.txt || true

          # ===== Markdown レポート組み立て =====
          cat > trivy-report.md <<EOF
          # Container security report

          Image: \`ghcr.io/${GHCR_OWNER}/${IMAGE_NAME}:${IMAGE_TAG}\`
          
          ## Vulnerabilities (HIGH / CRITICAL)
          
          | Target | CVE | Package | Installed | Fixed | Severity |
          |--------|-----|---------|-----------|-------|----------|
          EOF

          if [ -s vuln_rows.txt ]; then
            cat vuln_rows.txt >> trivy-report.md
          else
            echo "_No HIGH/CRITICAL vulnerabilities detected._" >> trivy-report.md
          fi

          # Secrets セクション
          if [ -s secret_rows.txt ]; then
            cat >> trivy-report.md <<'EOF2'

            ## Secrets
            
            | Target | RuleID | Category | Location | Severity |
            |--------|--------|----------|----------|----------|
            EOF2
            cat secret_rows.txt >> trivy-report.md
          else
            echo "" >> trivy-report.md
            echo "_No secrets detected._" >> trivy-report.md
          fi

          # Misconfig セクション
          if [ -s misconf_rows.txt ]; then
            cat >> trivy-report.md <<'EOF3'

            ## Misconfigurations
            
            | Target | ID | Title | Severity |
            |--------|----|-------|----------|
            EOF3
            cat misconf_rows.txt >> trivy-report.md
          else
            echo "" >> trivy-report.md
            echo "_No misconfigurations detected._" >> trivy-report.md
          fi

          echo "" >> trivy-report.md
          echo "> This issue was generated automatically by a scheduled GitHub Actions workflow." >> trivy-report.md

      # タグごとに Issue 作成 or 追記
      - name: Create or update issue for this tag
        if: steps.summary.outputs.total != '0'
        uses: actions/github-script@v7
        env:
          IMAGE_TAG: ${{ matrix.tag }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const tag = process.env.IMAGE_TAG;
            const title = `[Security] Vulnerabilities/Secrets/Misconfig found in GHCR image tag ${tag}`;
            const body = fs.readFileSync('trivy-report.md', 'utf8');

            // 同じタグ用のオープンIssueがあるか
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'container-security',
            });

            const existing = issues.find(i => i.title === title);

            if (existing) {
              core.info(`Existing issue #${existing.number} for tag ${tag}. Adding a comment.`);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                body,
              });
            } else {
              core.info(`Creating new issue for tag ${tag}.`);
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['container-security', 'security', 'automated'],
              });
            }
