name: Check Matomo Release and Create Issue (diff with GHCR latest)

permissions:
  contents: read
  packages: read
  issues: write

on:
  schedule:
    # 毎日 0:00 UTC 実行
    - cron: "0 0 * * *"
  workflow_dispatch: {}

env:
  IMAGE_NAME: matomo-appservice-rebuild

jobs:
  check-matomo-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      # 1) Matomo 最新バージョン取得
      - name: Get latest Matomo version
        id: matomo
        run: |
          echo "Fetching Matomo changelog feed..."
          latest=$(curl -s https://matomo.org/changelog/feed/ \
            | grep -oP 'Matomo \K[0-9]+\.[0-9]+(\.[0-9]+)?' \
            | head -n1)

          if [ -z "$latest" ]; then
            echo "Error: Could not parse latest Matomo version"
            exit 1
          fi

          echo "Matomo latest version: $latest"
          echo "latest=$latest" >> "$GITHUB_OUTPUT"

      # 2) GHCR の latest タグが指しているバージョンを取得
      - name: Get GHCR latest tag version
        id: ghcr
        env:
          OWNER: ${{ github.repository_owner }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching GHCR container versions for ${OWNER}/${IMAGE_NAME} ..."

          resp=$(curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/users/${OWNER}/packages/container/${IMAGE_NAME}/versions?per_page=100")

          echo "$resp" > versions.json

          # latest タグを持つエントリを探す
          latest_entry=$(echo "$resp" | jq -r '.[] | select(.metadata.container.tags[]? == "latest")')

          if [ -z "$latest_entry" ]; then
            echo "No 'latest' tag found in GHCR."
            echo "ghcr_latest_version=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # latest 以外のタグのうち最初のものを「latest が指す実バージョン」とみなす
          version=$(echo "$latest_entry" | jq -r '.metadata.container.tags[] | select(. != "latest")' | head -n1)

          echo "GHCR latest tag points to version: $version"
          echo "ghcr_latest_version=$version" >> "$GITHUB_OUTPUT"

      # 3) Matomo最新版 vs GHCR latest を比較し、差分があれば Issue 作成
      - name: Compare and create issue if needed
        env:
          MATOMO_LATEST: ${{ steps.matomo.outputs.latest }}
          GHCR_LATEST: ${{ steps.ghcr.outputs.ghcr_latest_version }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
        run: |
          echo "Matomo latest upstream version: $MATOMO_LATEST"
          echo "GHCR latest version:           ${GHCR_LATEST:-none}"

          create_issue="no"

          # GHCR に latest が無い、またはバージョンが違うなら Issue 対象
          if [ -z "$GHCR_LATEST" ]; then
            echo "No GHCR latest version found. Will create issue."
            create_issue="yes"
          elif [ "$MATOMO_LATEST" != "$GHCR_LATEST" ]; then
            echo "Version mismatch detected. Will create issue."
            create_issue="yes"
          fi

          if [ "$create_issue" != "yes" ]; then
            echo "Versions match. Nothing to do."
            exit 0
          fi

          title="Matomo ${MATOMO_LATEST} is available"

          # 重複 Issue がないか確認
          existing=$(curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/issues?state=open&per_page=100" \
            | jq -r '.[].title' \
            | grep -Fx "$title" || true)

          if [ -n "$existing" ]; then
            echo "Issue '$title' already exists. Skipping creation."
            exit 0
          fi

          body="A new Matomo version ${MATOMO_LATEST} is available. Current GHCR 'latest' points to ${GHCR_LATEST:-none}. Please build and publish:

          ghcr.io/${REPO%%/*}/${IMAGE_NAME}:${MATOMO_LATEST}
          "

          echo "Creating issue: $title"

          curl -s -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/issues" \
            -d "$(jq -n --arg title "$title" --arg body "$body" '{title: $title, body: $body}')"

          echo "Issue created."
