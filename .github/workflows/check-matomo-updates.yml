name: Check Matomo Release and Create Issue

permissions:
  contents: read
  packages: read
  issues: write

on:
  schedule:
    # 毎日 0:00 UTC に実行
    - cron: "0 0 * * *"
  workflow_dispatch: {}

env:
  IMAGE_NAME: matomo-appservice-rebuild

jobs:
  check-and-issue:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1) Matomo の RSS フィードから最新バージョンを取得
      - name: Get latest Matomo version from changelog feed
        id: matomo
        run: |
          echo "Fetching Matomo changelog feed..."
          latest=$(curl -s https://matomo.org/changelog/feed/ \
            | grep -oP 'Matomo \K[0-9]+\.[0-9]+(\.[0-9]+)?' \
            | head -n1)

          if [ -z "$latest" ]; then
            echo "Failed to detect latest Matomo version from feed" >&2
            exit 1
          fi

          echo "Latest Matomo version detected: $latest"
          echo "latest=$latest" >> "$GITHUB_OUTPUT"

      # 2) GHCR の latest タグが指しているイメージのバージョンを取得
      - name: Get current Matomo version from GHCR latest tag
        id: ghcr
        env:
          GHCR_OWNER: ${{ github.repository_owner }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching GHCR versions for $GHCR_OWNER/${IMAGE_NAME} ..."
          resp=$(curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/users/${GHCR_OWNER}/packages/container/${IMAGE_NAME}/versions?per_page=100")

          echo "$resp" > ghcr-versions.json

          # もし "Package not found." なら、パッケージ未作成として扱う
          if echo "$resp" | jq -e '.message? == "Package not found."' > /dev/null 2>&1; then
            echo "GHCR package not found. Treating as no existing image."
            echo "current=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # 配列で返ってきているか確認
          if ! echo "$resp" | jq -e 'type == "array"' > /dev/null 2>&1; then
            echo "Warning: Unexpected response from GHCR API:"
            cat ghcr-versions.json
            # current は空として扱う
            echo "current=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # latest タグが付いているエントリを探し、latest 以外のタグを「実バージョン」とみなす
          current=$(echo "$resp" | jq -r '
            [ .[] | select(.metadata.container.tags[]? == "latest") ]
            | first
            | .metadata.container.tags[]
            | select(. != "latest")
          ' | head -n1)

          if [ -z "$current" ]; then
            echo "No non-latest tag found for GHCR latest image. Treating as no existing version."
            echo "current=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Current Matomo version in GHCR latest: $current"
          echo "current=$current" >> "$GITHUB_OUTPUT"

      # 3) Matomo の最新バージョンと GHCR latest のバージョンを比較して、違えば Issue を作成
      - name: Compare latest upstream with GHCR latest and create issue if needed
        env:
          LATEST: ${{ steps.matomo.outputs.latest }}
          CURRENT: ${{ steps.ghcr.outputs.current }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          echo "Upstream latest Matomo version: $LATEST"
          echo "Current GHCR latest Matomo version: ${CURRENT:-<none>}"

          # GHCR にイメージがまだない場合（CURRENT が空）は、常に Issue 対象とする
          if [ -n "$CURRENT" ] && [ "$LATEST" = "$CURRENT" ]; then
            echo "GHCR latest already uses Matomo $LATEST. No issue created."
            exit 0
          fi

          if [ -z "$CURRENT" ]; then
            echo "No existing GHCR latest image. Will create issue for initial build of Matomo $LATEST."
          else
            echo "Upstream $LATEST is different from GHCR latest $CURRENT. Will create/update issue."
          fi

          issue_title="Matomo ${LATEST} is available"

          echo "Checking existing issues for '$issue_title'..."
          existing=$(curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/issues?state=open&per_page=100" \
            | jq -r '.[].title' \
            | grep -Fx "$issue_title" || true)

          if [ -n "$existing" ]; then
            echo "Issue '$issue_title' already exists. Skipping creation."
            exit 0
          fi

          echo "Creating new issue: $issue_title"

          if [ -z "$CURRENT" ]; then
            body="A new Matomo version ${LATEST} is available. There is currently no GHCR image (${IMAGE_NAME}) for this repository. Please build and publish an initial image using this version."
          else
            body="A new Matomo version ${LATEST} is available. The current GHCR latest image (${IMAGE_NAME}) seems to use ${CURRENT}. Please check https://matomo.org/changelog/feed/ and update the container image if appropriate."
          fi

          curl -s -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/issues" \
            -d "$(jq -n --arg title "$issue_title" --arg body "$body" '{title: $title, body: $body}')"

          echo "Issue created."
