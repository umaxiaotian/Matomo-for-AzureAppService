name: Build & Test & Push Matomo Image (DockerHub)

on:
  # æ‰‹å‹•å®Ÿè¡Œç”¨
  workflow_dispatch:
    inputs:
      matomo_version:
        description: "Matomo version (e.g. 5.6.1)"
        required: true
        default: "5.6.1"
      php_memory_limit:
        description: "PHP memory_limit (e.g. 256M)"
        required: true
        default: "256M"

env:
  IMAGE_NAME: matomo-appservice-rebuild

jobs:
  # =========================
  # 1) ãƒ“ãƒ«ãƒ‰ & ãƒ†ã‚¹ãƒˆç”¨ã‚¸ãƒ§ãƒ–
  # =========================
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # å…¥åŠ›å€¤ã‹ã‚‰ .env ã‚’ç”Ÿæˆï¼ˆå¿…è¦ãªã‚‰ãƒ­ãƒ¼ã‚«ãƒ« docker-compose ã§ã‚‚ä½¿ãˆã‚‹ï¼‰
      - name: Generate .env file
        run: |
          cat <<EOF > .env
          MATOMO_VERSION=${{ inputs.matomo_version }}
          PHP_MEMORY_LIMIT=${{ inputs.php_memory_limit }}
          EOF
          echo ".env generated:"
          cat .env

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ãƒ†ã‚¹ãƒˆç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ï¼ˆpush ã—ãªã„ / runner ã« loadï¼‰
      - name: Build image for test (no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          build-args: |
            MATOMO_VERSION=${{ inputs.matomo_version }}
            PHP_MEMORY_LIMIT=${{ inputs.php_memory_limit }}
          tags: |
            matomo-test:${{ github.sha }}

      # ç°¡æ˜“ PHP æ‹¡å¼µãƒã‚§ãƒƒã‚¯
      - name: Simple PHP extension check
        run: |
          set -e

          echo "== php -m =="
          docker run --rm matomo-test:${{ github.sha }} php -m

          echo "== check required extensions =="
          for ext in gd mysqli pdo_mysql bcmath zip redis apcu; do
            echo "Checking extension: $ext"
            if ! docker run --rm matomo-test:${{ github.sha }} php -m | grep -q "$ext"; then
              echo "ERROR: PHP extension '$ext' not found."
              exit 1
            fi
          done

      - name: HTTP smoke test (apache + matomo)
        run: |
          set -e

          # æ°¸ç¶šç”¨ã® named volume ã‚’ç”¨æ„ï¼ˆCIå†…ï¼‰
          docker volume create matomo_data >/dev/null

          # volume å†…ã‚’ www-data(33:33) æ‰€æœ‰ã«ã™ã‚‹ï¼ˆâ€»ã‚³ãƒ³ãƒ†ãƒŠå´ã§ chown ã—ãŸããªã„ã®ã§ã€ã“ã“ã§ã‚„ã‚‹ï¼‰
          docker run --rm -v matomo_data:/home/matomo-data busybox sh -lc '
            mkdir -p /home/matomo-data &&
            chown -R 33:33 /home/matomo-data
          '

          # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ï¼ˆæ°¸ç¶š volume ã‚’ /home/matomo-data ã«ãƒã‚¦ãƒ³ãƒˆï¼‰
          docker run -d --name matomo-http-test \
            -p 8080:80 \
            -v matomo_data:/home/matomo-data \
            matomo-test:${{ github.sha }}

          echo "Waiting for container to be ready..."
          # åˆå›å±•é–‹ãŒã‚ã‚‹ã®ã§å°‘ã—å¾…ã¤
          for i in $(seq 1 60); do
            if curl -sS -o /tmp/index.html -w "%{http_code}" http://localhost:8080/ | grep -qE '^(200|302)$'; then
              break
            fi
            sleep 2
          done

          echo "Requesting http://localhost:8080/ ..."
          http_status=$(curl -sS -o /tmp/index.html -w "%{http_code}" http://localhost:8080/ || echo "000")
          echo "HTTP status: $http_status"

          if [ "$http_status" != "200" ] && [ "$http_status" != "302" ]; then
            echo "ERROR: Expected HTTP 200/302 but got $http_status"
            echo "===== /tmp/index.html (if any) ====="
            cat /tmp/index.html || true
            echo "===== Container logs ====="
            docker logs matomo-http-test || true
            docker rm -f matomo-http-test || true
            exit 1
          fi

          echo "===== /tmp/index.html (head) ====="
          head -n 50 /tmp/index.html || true

          echo "===== Container logs ====="
          docker logs matomo-http-test || true

          docker rm -f matomo-http-test || true

      # ğŸ” Trivy ã«ã‚ˆã‚‹è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆHIGH/CRITICAL ãŒã‚ã‚Œã°å¤±æ•—ã•ã›ã‚‹ï¼‰
      - name: Scan image for vulnerabilities (Trivy)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: matomo-test:${{ github.sha }}
          vuln-type: 'os,library'
          severity: 'HIGH,CRITICAL'
          ignore-unfixed: true
          format: 'table'
          exit-code: '1'   # â† HIGH/CRITICAL ãŒ1ä»¶ã§ã‚‚ã‚ã‚Œã°ã‚¸ãƒ§ãƒ–å¤±æ•—

  # =========================
  # 2) ãƒ—ãƒƒã‚·ãƒ¥å°‚ç”¨ã‚¸ãƒ§ãƒ–
  # =========================
  push:
    runs-on: ubuntu-latest
    needs: build-and-test   # â† ãƒ†ã‚¹ãƒˆ + è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯é€šã£ãŸã‚‰ã ã‘å®Ÿè¡Œ

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate .env file
        run: |
          cat <<EOF > .env
          MATOMO_VERSION=${{ inputs.matomo_version }}
          PHP_MEMORY_LIMIT=${{ inputs.php_memory_limit }}
          EOF
          echo ".env generated:"
          cat .env

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}   # ex: umaxiaotian
          password: ${{ secrets.DOCKERHUB_TOKEN }}      # Docker Hub ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³

      - name: Build and push to Docker Hub
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          build-args: |
            MATOMO_VERSION=${{ inputs.matomo_version }}
            PHP_MEMORY_LIMIT=${{ inputs.php_memory_limit }}
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ inputs.matomo_version }}
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
